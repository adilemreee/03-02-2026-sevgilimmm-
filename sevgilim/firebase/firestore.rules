rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // =============================================
    // HELPER FUNCTIONS
    // =============================================
    
    // Kullanıcı giriş yapmış mı?
    function isSignedIn() {
      return request.auth != null && request.auth.uid != null;
    }
    
    // Kullanıcı dökümanını al
    function getUserDocument(userId) {
      return get(/databases/$(database)/documents/users/$(userId));
    }
    
    // Kullanıcının relationship ID'sini al
    function getUserRelationshipId(userId) {
      return getUserDocument(userId).data.relationshipId;
    }
    
    // İlişkinin üyesi mi?
    function isRelationshipMember(relationshipId) {
      return isSignedIn() && getUserRelationshipId(request.auth.uid) == relationshipId;
    }
    
    // Relationship dökümanını al
    function getRelationship(relationshipId) {
      return get(/databases/$(database)/documents/relationships/$(relationshipId));
    }
    
    // Partner ID'sini al
    function getPartnerId(relationshipId) {
      let rel = getRelationship(relationshipId);
      return rel.data.user1Id == request.auth.uid ? rel.data.user2Id : rel.data.user1Id;
    }
    
    // İki kullanıcı aynı ilişkide mi?
    function arePartners(userId1, userId2) {
      return isSignedIn() 
        && getUserRelationshipId(userId1) != null
        && getUserRelationshipId(userId1) == getUserRelationshipId(userId2);
    }
    
    // =============================================
    // USERS COLLECTION
    // =============================================
    match /users/{userId} {
      // Herkes okuyabilir (profil bilgileri için)
      allow read: if isSignedIn();
      
      // Sadece kendi kaydını yazabilir
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }
    
    // =============================================
    // RELATIONSHIPS COLLECTION
    // =============================================
    match /relationships/{relationshipId} {
      // İlişki üyeleri okuyabilir
      allow read: if isSignedIn() && isRelationshipMember(relationshipId);
      
      // İlişki üyeleri güncelleyebilir
      allow update: if isSignedIn() && isRelationshipMember(relationshipId);
      
      // Silme sadece üyeler tarafından
      allow delete: if isSignedIn() && isRelationshipMember(relationshipId);
      
      // Oluşturma - kullanıcı ilişkinin parçası olmalı
      allow create: if isSignedIn() 
        && (request.resource.data.user1Id == request.auth.uid 
            || request.resource.data.user2Id == request.auth.uid);
    }
    
    // =============================================
    // USER LOCATIONS COLLECTION
    // =============================================
    match /userLocations/{userId} {
      // Kendi konumunu ve partner'ın konumunu okuyabilir
      allow read: if isSignedIn() 
        && (request.auth.uid == userId || arePartners(request.auth.uid, userId));
      
      // Sadece kendi konumunu yazabilir
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
    
    // =============================================
    // MEETING EVENTS COLLECTION
    // =============================================
    match /meetingEvents/{meetingId} {
      // İlişki üyeleri okuyabilir
      allow read: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      
      // İlişki üyeleri oluşturabilir
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId)
        && (request.resource.data.user1Id == request.auth.uid 
            || request.resource.data.user2Id == request.auth.uid);
      
      // İlişki üyeleri güncelleyebilir
      allow update: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      
      // İlişki üyeleri silebilir
      allow delete: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
    }
    
    // =============================================
    // INVITATIONS COLLECTION
    // =============================================
    match /invitations/{invitationId} {
      // Gönderen veya alıcı okuyabilir
      allow read: if isSignedIn() 
        && (resource.data.senderUserId == request.auth.uid 
            || resource.data.receiverEmail == request.auth.token.email);
      
      // Giriş yapmış kullanıcı oluşturabilir
      allow create: if isSignedIn() 
        && request.resource.data.senderUserId == request.auth.uid;
      
      // Alıcı veya gönderen güncelleyebilir
      allow update: if isSignedIn() 
        && (resource.data.senderUserId == request.auth.uid 
            || resource.data.receiverEmail == request.auth.token.email);
      
      // Gönderen silebilir
      allow delete: if isSignedIn() 
        && resource.data.senderUserId == request.auth.uid;
    }
    
    // =============================================
    // MESSAGES COLLECTION
    // =============================================
    match /messages/{messageId} {
      allow read: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId)
        && request.resource.data.senderId == request.auth.uid;
      
      allow update: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      
      allow delete: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
    }
    
    // =============================================
    // PENDING NOTIFICATIONS COLLECTION
    // (Cloud Functions tarafından işlenir)
    // =============================================
    match /pendingNotifications/{notificationId} {
      // Sadece oluşturma - Cloud Function tarafından silinir
      allow create: if isSignedIn();
      allow read: if false; // Sadece Cloud Functions okur
      allow update: if false;
      allow delete: if false;
    }
    
    // =============================================
    // GENERIC RELATIONSHIP-BASED COLLECTIONS
    // =============================================
    
    // Memories
    match /memories/{memoryId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // Photos
    match /photos/{photoId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // Notes
    match /notes/{noteId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // Movies
    match /movies/{movieId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // Plans
    match /plans/{planId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // Places
    match /places/{placeId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // Songs
    match /songs/{songId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // Stories
    match /stories/{storyId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // Surprises
    match /surprises/{surpriseId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // SpecialDays
    match /specialDays/{specialDayId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // Moods
    match /moods/{moodId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
    
    // SecretVault
    match /secretVault/{itemId} {
      allow read, write: if isSignedIn() 
        && isRelationshipMember(resource.data.relationshipId);
      allow create: if isSignedIn() 
        && isRelationshipMember(request.resource.data.relationshipId);
    }
  }
}
